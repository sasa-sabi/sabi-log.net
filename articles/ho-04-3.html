<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width,initial-scale=1"/>
	<meta name="description" content="笹錆のひとりごと、読んでほしい"/>
	<meta name="format-detection" content="telephone=no"/>
	<meta name="keywords" content="笹錆,日記,個人ブログ,@Today_chokankyo,クオルティゴヤス"/>

  <link rel="shortcut icon" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189203/system%20images/favicon/favicon_es0idv.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189203/system%20images/favicon/apple-touch-icon_lplyzb.png" />
  <link rel="apple-touch-icon" sizes="57x57" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189203/system%20images/favicon/apple-touch-icon-57x57_xgnlql.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189203/system%20images/favicon/apple-touch-icon-72x72_ozcelu.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189203/system%20images/favicon/apple-touch-icon-76x76_wrgpx8.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189202/system%20images/favicon/apple-touch-icon-114x114_qz6dkn.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189202/system%20images/favicon/apple-touch-icon-120x120_yn4frq.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189202/system%20images/favicon/apple-touch-icon-144x144_okevmd.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189202/system%20images/favicon/apple-touch-icon-152x152_crubvw.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189202/system%20images/favicon/apple-touch-icon-180x180_zfbwwn.png" />
  <!-- android用を追加 -->

	<meta property="og:site_name" content="笹錆ログ"/>
	<meta property="og:url" content="https://sabi-log.net/"/>
	<meta property="og:type" content="blog"/>
	<meta property="og:title" content="クソサイトを量産した〜い - 笹錆ログ"/>
	<meta property="og:description" content="クソサイト、作りたいですよね。"/>
	<meta property="og:image" content="https://res.cloudinary.com/dtifkcohv/image/upload/v1689770783/system%20images/archive/top_image_4_jkjutl.png"/>
	<meta property="og:locale" content="ja_JP"/>

	<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:site" content="@Today_chokankyo"/>
	<meta name="twitter:description" content="クソサイト、作りたいですよね。" />
	<meta name="twitter:image:src" content="https://res.cloudinary.com/dtifkcohv/image/upload/v1689770783/system%20images/archive/top_image_4_jkjutl.png" />

	<title>クソサイトを量産した〜い - 笹錆ログ </title>

	<link rel="stylesheet" media="all" href="../css/article.css">
  <script src="../javascript/hamburg.js"></script>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0EMMB2N6XP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0EMMB2N6XP');
</script>
</head>

<body>
  <header>
    <div class="container">
      <a class="header-left" href="../index.html"> 笹錆ログ </a>

      <div class="header-right pc-head">
        <a href="#">日替わり</a>
        <a href="../archive.html">記事</a>
        <a href="../profile.html">プロフィール</a>
      </div>

      <div class="header-right hamburger-menu" id="js-hamburger">
        <div class="hamburger-menu-line"></div>
        <div class="hamburger-menu-line"></div>
        <div class="hamburger-menu-line"></div>
      </div>

      <nav class="navigation-menu" id="js-nav">
        <ul>
          <li class="nav-top"></li>
          <li><a href="#">日替わり</a></li>
          <li><a href="../archive.html">記事</a></li>
          <li><a href="../profile.html">プロフィール</a></li>
        </ul>
      </nav>
      
    </div>
  </header>
<div class="toppage"><div class="art-header">
	<div class="toppageImage" style="background-image: url(https://res.cloudinary.com/dtifkcohv/image/upload/v1689770783/system%20images/archive/top_image_4_jkjutl.png);"></div>
		<h1>クソサイトを量産した〜い</h1>
		<p>これは、クソサイトでお金を稼ぎたい話。</p>
	<div class="toppageIcons">
			<a class="topTagIcon" style="display: inline-block;" href="../archive.html">
				<div>
					<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689904919/system%20images/article%20icons/back_rm9wo7.png" class="topiconimg">
					<strong>記事一覧<br></strong>
				</div>
			</a>
			<a class="topTwitterIcon" style="display: inline-block;" href="https://twitter.com/share?url=sabi-log.net/articles/ho-04.html&amp;text=クソサイト、作りたいですよね。" >
				<div>
					<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689904919/system%20images/article%20icons/tweet_yvetxv.png" class="topiconimg">
					<strong>ツイート</strong>
				</div>
			</a>
			<a class="topIssueIcon" style="display: inline-block;" href="https://github.com/sasa-sabi/sabi-log.net/issues">
				<div>
					<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689857032/system%20images/article%20icons/issue_ocfhyr.png" class="topiconimg">
					<strong>訂正</strong>
				</div>
			</a>
			<a class="topTimeIcon" style="display: inline-block;" href="../ur/ur-04.html">
				<div>
					<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689857032/system%20images/article%20icons/ura_hgg0np.png" class="topiconimg">
					<strong>裏話</strong>
				</div>
			</a>
    	</div>
	</div>
</div></div>

<div class="headline"><div class="top-window">
  <div class="top-pages">
    <a href="./ho-04-2.html" class="page"><strong>prev</strong></a>
    <a href="./ho-04-2.html" class="page"><strong>2</strong></a>
    <a class="now-page"><strong>3</strong></a>
    <a href="./ho-04-4.html" class="page"><strong>4</strong></a>
    <a href="./ho-04-4.html" class="page"><strong>next</strong></a>
  </div>

		<h2>拡張機能の作成</h2>
		<p><strong class="p-str">基礎ファイルの作成</strong></p><p>とはいっても、拡張機能を作ろうと思ったことがないので、作り方自体知りません。
		<br>色々と調べながら、試し試しやっていきましょう。
		<br>どうやらnpmで構成ファイルを作るのが簡単なようです。
		<br>とりあえずgenerator-codeをインストールします。
		</p>
		<pre class="code shell"><code>npm install -g yo generator-code
</code></pre>
		<p>
これをインストールすると、VS拡張の雛型を作ることができます。
		<br>雛型の生成にはこれを実行します。
		</p>
		<pre class="code shell"><code>yo code
</code></pre>
		
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689706845/system%20images/member/member_O_512_xpyspz.png" class="art-image" />
		<p>え、誰？？？？？
		<br>なんかよく知らない人が突然出てきました。
		</p>
		<div class="balloon-set-box"><div class="icon-box"><img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689706845/system%20images/member/member_O_512_xpyspz.png" class="icon"><p>おじ</p></div><div class="balloon"><p>……で……たい？</p></div></div>
		<p>ん？？？？？？
		</p>
		<div class="balloon-set-box"><div class="icon-box"><img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689706845/system%20images/member/member_O_512_xpyspz.png" class="icon"><p>おじ</p></div><div class="balloon"><p>どんな言語で作りたい？？？</p></div></div>
		
		<div class="balloon-set-box"><div class="icon-box"><img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189206/system%20images/member/member_sabi_512_lzx62f.png" class="icon"><p>笹錆</p></div><div class="balloon"><p>突然怪しい人が真面目な質問してきた。</p></div></div>
		<p>とりあえずこのおじさんに従っていけば雛型は作れそうです。
		<br>おじさんからの質問は次の通りです。
		</p>
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689679356/art-4/img10_u8mnu6.png" class="art-image" />
		<p>これに答え終わると、いっぱいファイルが生成されます。
		</p>
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689679613/art-4/img11_dtxaze.png" class="art-image" />
		<p>大変そうな作業に思われますが、この中でいじるのはextention.tsとpackage.jsだけでいいです。
		<br>実際の機能に関わるのがextention、その機能の呼び出し方に関わるのがpackage.jsです。
		</p><p><strong class="p-str">機能の実装</strong></p><p>先ほど作ったJavascriptと同じ処理をextentionに書いていきましょう。
		<br>言語が違いますが、TypescriptはJavascript亜種みたいなものなので、結構簡単に移し替えられます。
		</p>
		<pre class="code typescript"><code>// Markdownのコンバート
function convert(code: string, dictionary: Record&lt;string, string&gt;) {
  // Javascriptで書いた処理
}<br>// コンバートと表示
function convertAndDisplay(mark: vscode.TextEditor) {
  var convertedHtml = &quot;&quot;;
  var markdown = mark.document.getText();
  const pages = markdown.split(&quot;--p&quot;);
  for (var k = 0; k &lt; pages.length; k++) {
    const paragraphs = pages[k].split(&quot;---&quot;); // 「---」で文章を区切る
    for (var i = 0; i &lt; paragraphs.length; i++) {
      var paragraph = paragraphs[i].trim();
      if (i === 0) {
        convertedHtml +=
          &apos;&lt;div class=&quot;toppage&quot;&gt;&lt;div class=&quot;window&quot;&gt;&apos; +
          convert(paragraph, dictional) +
          &apos;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;headline&quot;&gt;&apos;;
      } else if (i === 1) {
        if (i === paragraphs.length - 1) {
          convertedHtml +=
            &apos;&lt;div class=&quot;top-window window-end&quot;&gt;&apos; +
            convert(paragraph, dictional) +
            &quot;&lt;/div&gt;&quot;;
        } else {
          convertedHtml +=
            &apos;&lt;div class=&quot;top-window&quot;&gt;&apos; +
            convert(paragraph, dictional) +
            &quot;&lt;/div&gt;&quot;;
        }
      } else if (i === paragraphs.length - 1) {
        convertedHtml +=
          &apos;&lt;div class=&quot;window window-end&quot;&gt;&apos; +
          convert(paragraph, dictional) +
          &quot;&lt;/div&gt;&quot;;
      } else {
        convertedHtml +=
          &apos;&lt;div class=&quot;window&quot;&gt;&apos; + convert(paragraph, dictional) + &quot;&lt;/div&gt;&quot;;
      }
    }
    convertedHtml += &quot;&lt;/div&gt;&quot;;
  }<br>  return convertedHtml;
}
</code></pre>
		<p>詳しいことは公式のリファンスを読んで欲しいのですが、現在表示しているファイルに書かれている文章をHTMLに起こす処理を1秒ごとに行っています。
		<br>なので、あとはHTMLへの返還を行なう関数と、ダウンロードを行う関数を作ります。
		<br>こんな感じで書くと、sabilog.marks、sabilog.convertのコマンドでそれぞれの処理を行なうことができます。
		<br>marksの方はMarkdownからHTMLに変換して表示、convertは変換したものをダウンロードします。
		</p>
		<pre class="code typescript"><code>// エディタの表示
function getWebviewContent(marks: string) {
  return `&lt;!DOCTYPE html&gt;
			&lt;html lang=&quot;ja&quot;&gt;
				&lt;head&gt;
				&lt;meta charset=&quot;UTF-8&quot;&gt;
				&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
				&lt;/head&gt;
				&lt;body&gt;
			  ${marks}
				&lt;/body&gt;
			&lt;/html&gt;`;
}<br>export function activate(context: vscode.ExtensionContext) {
  // marksコマンドの処理
  let disposable = vscode.commands.registerCommand(&quot;sabilog.marks&quot;, () =&gt; {
    const textdox = vscode.window.activeTextEditor;
    const panel = vscode.window.createWebviewPanel(
      &quot;markdown editor&quot;,
      &quot;MARKS EDITOR&quot;,
      vscode.ViewColumn.One,
      {}
    );
    const updateWebview = () =&gt; {
      if (textdox !== undefined) {
        panel.webview.html = getWebviewContent(convertAndDisplay(textdox));
      }
    };
    setInterval(updateWebview, 1000); // 重くなるので注意
  });<br>  // convertコマンドの処理
  context.subscriptions.push(
    vscode.commands.registerCommand(&quot;sabilog.convert&quot;, () =&gt; {
      (async () =&gt; {
        // ファイルを読み込む
        const editor = vscode.window.activeTextEditor;
        var filepath: string = editor?.document?.fileName || &quot;&quot;;
        filepath = filepath.replace(/\.md$/, &quot;.html&quot;);
        // テキストをUint8Arrayに変換
        var panel: string = &quot;&quot;;
        if (editor !== undefined) {
          panel = convertAndDisplay(editor);
        }
        vscode.window.showInformationMessage(`${filepath}`);
        const blob: Uint8Array = Buffer.from(`${panel}`);
        // ファイルへ書き込む
        await vscode.workspace.fs.writeFile(vscode.Uri.file(filepath), blob);
      })();
      vscode.window.showInformationMessage(&quot;exe convert!&quot;);
    })
  );
  context.subscriptions.push(disposable);
}
export function deactivate() {}
</code></pre>
		<p>すると、こんな感じで表示されます。
		</p>
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689696569/art-4/img12_aoikn9.png" class="art-image" />
		<p>見やすいし使いやすい！！！！
		<br>やっぱり慣れてるツールだと書きやすいですね。
		<br>あと移行自体が簡単で、TypeScriptの強みを感じますね。
		<br>ですが、いちいちコマンドパレットを開いて編集するのも面倒ですね。
		<br>そこで、ダウンロードはボタンで行えるようにもします。
		</p>
		<pre class="code typescript"><code>export function activate(context: vscode.ExtensionContext) {
  // ダウンロードボタンを追加
  const downloadbutton = vscode.window.createStatusBarItem(
    vscode.StatusBarAlignment.Right,
    -20
  );
  downloadbutton.text = &quot;Download&quot;;
  downloadbutton.tooltip = &quot;Convert this markdown to HTML&quot;;
  downloadbutton.command = &quot;sabilog.convert&quot;;<br>  // ボタンの表示
  context.subscriptions.push(
    vscode.window.onDidChangeActiveTextEditor((editor) =&gt; {
      if (editor &amp;&amp; editor.document.languageId === &quot;markdown&quot;) {
        downloadbutton.show();
      } else {
        downloadbutton.hide();
      }
    })
  );
}
</code></pre>
		<p>これでステータスバーにダウンロードボタンが追加されます。
		</p>
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689697743/art-4/img13_a3h53f.png" class="art-image" />
		<p>他にも色々表示されていますが、これらは僕が個人的に入れていた拡張機能です。
		<br>確かMarkdownを表示するやつだった気がします。
		<br>もしかして、その拡張機能のCSSをちょっと変えたらもっと楽にできたのでは？
		<br>あれ？？？
		</p><p><strong class="p-str">Notion APIの使用</strong></p><p>嫌なことに気付きそうになりましたが、とりあえず作業を進めます。
		<br>現状ではHTMLで作っていたエディタをVScodeに移せましたが、Notionを利用してもっと簡単に記述したいですよね。
		<br>というわけで、Notion APIを使ってMarkdownファイルを得られるようにしましょう。
		<br>APIを使うためには、ワークスペースIDとトークンが必要になります。
		<br>公式のリファレンスを見ると、なんか、こう上手いことやってあげることでページ内の要素を引っ張り出せるみたいです。
		<br>実際にインテグレーションを作るとこんな感じです。
		</p>
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689698776/art-4/img14_ikmqxq.png" class="art-image" />
		<p>ここに書かれているのがトークンです。
		<br>ついでに書いてた記事をまとめたページとインテグレーションをつなげます。
		</p>
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689698775/art-4/img15_ude57e.png" class="art-image" />
		<p>このページのurlに書かれた32文字がデータベースIDです。
		<br>というわけで、実際に使ってみました。
		</p>
		<pre class="code typescript"><code>import { Client } from &quot;@notionhq/client&quot;;<br>const notionToken = &quot;secret_〇〇&quot;;
const notionDatabaseID = &quot;△△&quot;;<br>const notion = new Client({
  auth: notionToken,
});<br>const pageIdDictionary = {};<br>export const getDatabase = async (databaseId: string) =&gt; {
  const response = await notion.databases.query({
    database_id: databaseId || &quot;&quot;,
  });
  return response;
};<br>// セレクトメニュー用
export const getPage = async (pageId: string) =&gt; {
  const response = await notion.pages.retrieve({
    page_id: pageId,
  });
  return response;
};<br>// 選択肢の名前の取得
export const getPageTitle = async (databaseId: string) =&gt; {
  var selectIDs = [];
  const database = await getDatabase(databaseId);
  for (var i = 0; i &lt; database.results.length; i++) {
    const pagetitle = database.results[i].properties.名前.title[0].text.content;
    pageIdDictionary[pagetitle] = database.results[i].id.trim();
    selectIDs.push(pagetitle);
  }<br>  return selectIDs;
};
</code></pre>
		<p>これらの関数は、トークンとデータベースIDからリストにあるページのタイトルを読み取ってくれるやつです。
		<br>ここに、読み取ったタイトルを実際に並べてメニューみたいにする処理を書き加えましょう。
		</p>
		<pre class="code typescript"><code>export function activate(context: vscode.ExtensionContext) {
  // セレクトボタンを追加
  const selectButton = vscode.window.createStatusBarItem(
    vscode.StatusBarAlignment.Right,
    -10
  );
  selectButton.text = &quot;$(list-selection)Notion&quot;;
  selectButton.tooltip = &quot;Download by Notion&quot;;
  selectButton.command = &quot;sabilog.selectmenu&quot;;
  // ボタンの表示
  context.subscriptions.push(
    vscode.window.onDidChangeActiveTextEditor((editor) =&gt; {
      if (editor &amp;&amp; editor.document.languageId === &quot;markdown&quot;) {
        selectButton.show();
      } else {
        selectButton.hide();
      }
    })
  );
  // セレクトメニューのコマンド
  context.subscriptions.push(
    vscode.commands.registerCommand(&quot;sabilog.selectmenu&quot;, async () =&gt; {
      // 選択肢の名前の取得
      var selectoption = getPageTitle(notionDatabaseID);<br>      // 選択肢を表示
      const selectedOption = await vscode.window.showQuickPick(selectoption, {
        placeHolder: &quot;Select an article title&quot;,
      });
      if (selectedOption) {
        const activeEditor = vscode.window.activeTextEditor;
        if (activeEditor) {
          const path = require(&quot;path&quot;);
          const selecttitle: string = selectedOption;
          const selectpageId = pageIdDictionary[selectedOption];
          const file_name = await vscode.window.showInputBox({
            title: &quot;What name do you want to save it with?&quot;,
            value: `${path.basename(activeEditor.document.fileName)}`,
          });
          if (file_name) {
            convertMarkdown(selectpageId, selecttitle, file_name);
          }
        }
      }
    })
  );
}
</code></pre>
		<p>これで右下にNotionボタンができ、それを押すとリストに載っていた記事が全て表示されます。
		</p>
		<img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1689700103/art-4/img16_lhscct.png" class="art-image" />
		<p>ページのリストを選択することで、文章をダウンロードできるようになっています。
		<br>ダウンロードはページ内部を取得し、読み取ったブロックのrich_textを読み取ることで行なっています。
		<br>これでスマホで編集しても、VScode上で読み込むことが可能になりました。
		<br>
</p>
		<div class="balloon-set-box"><div class="icon-box"><img src="https://res.cloudinary.com/dtifkcohv/image/upload/v1687189206/system%20images/member/member_sabi_512_lzx62f.png" class="icon"><p>笹錆</p></div><div class="balloon"><p>満足したし、これで完成にするか。</p></div></div>
		
		<h2>実戦2</h2>
		<p>というわけで、VScodeの拡張機能で記事を書くためのあれこれが一元化されました。
		<br>なんならこの後も、ダウンロード処理が行われたときにアーカイブとかも自動で更新する機能をつけたり、VScodeからNotionに文章を送信できるようにしましたが、とりあえず記事で解説する部分はここまでとさせてください。
		<br>というかほとんど解説していないので、この記事を読んで拡張機能まで作れた人はなんでもできると思います。
		<br>ですが、エディタを作ってはい終わり、というわけにはいきません。
		<br>元々の目的はこれを使ってクソ記事を量産すること。
		<br>早速量産していきましょう。</p>

    <div class="pages">
      <a href="./ho-04-4.html" class="page"><strong>next:量産へ</strong></a>
    </div>
  </div></div>
        </body>

<footer>
  <div class="container">
    <div class="site_cr">
      <a>2023- ©笹錆</a>
    </div>
    <div class="site_legal">
      <a href="../legal.html">Legal info</a>
    </div>
  </div>
</footer>

</html>